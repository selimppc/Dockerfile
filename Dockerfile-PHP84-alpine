# ---- wkhtmltopdf stage (built for Alpine 3.22)
FROM surnet/alpine-wkhtmltopdf:3.22.0-0.12.6-full AS wkhtml

# ---- your PHP base
FROM php:8.4.12-fpm-alpine3.22
LABEL maintainer="developer@hwg.nl"

# Update and install essential libraries and PHP dependencies
RUN apk update && apk add --no-cache \
    shadow \
    curl \
    tini \
    supervisor \
    jpegoptim \
    optipng \
    pngquant \
    gifsicle \
    composer \
    libwebp-tools \
    ghostscript \
    libgcc libstdc++ libx11 glib libxrender libxext libintl \
    fontconfig \
    ttf-dejavu ttf-droid ttf-freefont ttf-liberation \
    mysql-client \
    bash \
    icu-libs \
    icu-dev

# Install pdo_mysql and intl extensions
RUN docker-php-ext-configure intl \
    && docker-php-ext-install pdo_mysql intl \
    && apk del icu-dev

# (Removed) openssl1.1-compat â€” not available on Alpine 3.22
# RUN apk add --no-cache --repository=... openssl1.1-compat

# Download and install PHP Extension Installer
ADD https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/
RUN chmod +x /usr/local/bin/install-php-extensions

# Install additional PHP extensions (the tool pulls build deps as needed and cleans up)
RUN install-php-extensions \
    opcache \
    mcrypt \
    redis \
    sysvsem \
    zip \
    bcmath \
    gd \
    exif \
    pcntl \
    soap \
    imagick \
    ctype \
    dom \
    fileinfo \
    simplexml \
    xml \
    xmlreader \
    xmlwriter

# Copy wkhtmltopdf (and wkhtmltoimage) from the 3.22-compatible stage
COPY --from=wkhtml /bin/wkhtmltopdf /usr/local/bin/wkhtmltopdf
COPY --from=wkhtml /bin/wkhtmltoimage /usr/local/bin/wkhtmltoimage

# Set up PHP user permissions and configurations
RUN adduser -D -h /home/php -u 1000 php && \
    usermod -u 1000 php && \
    usermod -s /bin/ash php && \
    usermod -m -d /home/php php && \
    chown -R php /var/log && \
    chmod -R g+w /var/log
